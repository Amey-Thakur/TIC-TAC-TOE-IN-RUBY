<!DOCTYPE html>
<html>

<head>
    <title>Tic Tac Toe in Ruby | Amey & Mega</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="docs/Ruby%20Logo.png" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.js"></script>

    <!-- IMPORT MAP: The modern way to handle bare imports in browser -->
    <script type="importmap">
    {
      "imports": {
        "@ruby/3.3-wasm-wasi": "https://cdn.jsdelivr.net/npm/@ruby/3.3-wasm-wasi@2.6.0/dist/esm/index.js",
        "@ruby/wasm-wasi": "https://cdn.jsdelivr.net/npm/@ruby/wasm-wasi@2.6.0/dist/esm/index.js"
      }
    }
    </script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-family: monospace;
        }

        #terminal {
            width: 100%;
            height: 100%;
            display: none;
        }

        #status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            max-width: 90%;
            width: 600px;
        }

        .error {
            color: #ff5555;
            background: #330000;
            padding: 10px;
            border: 1px solid #ff0000;
            margin-top: 20px;
            white-space: pre-wrap;
            text-align: left;
            font-size: 0.8em;
        }

        #log {
            margin-top: 1em;
            font-size: 0.9em;
            opacity: 0.8;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            background: #111;
            padding: 10px;
            border: 1px solid #333;
        }

        .log-entry {
            margin: 2px 0;
            border-bottom: 1px solid #222;
        }
    </style>
</head>

<body>
    <div id="terminal"></div>
    <div id="status">
        <h1>Initializing System...</h1>
        <div id="progressBar" style="width: 100%; height: 4px; background: #333; margin: 10px 0;">
            <div id="progressFill" style="width: 0%; height: 100%; background: #cc0000; transition: width 0.3s;"></div>
        </div>
        <div id="log"></div>
    </div>

    <!-- Logger Script -->
    <script>
        const logDiv = document.getElementById("log");
        const progressFill = document.getElementById("progressFill");

        function log(msg, isError = false) {
            const div = document.createElement("div");
            div.className = "log-entry";
            div.textContent = `> ${msg}`;
            if (isError) {
                div.style.color = "#ff5555";
                console.error(msg);
            } else {
                console.log(msg);
            }
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateProgress(percent) {
            progressFill.style.width = `${percent}%`;
        }

        window.onerror = function (msg, url, lineNo, columnNo, error) {
            log(`CRITICAL ERROR: ${msg}\nLine: ${lineNo}`, true);
            return false;
        };

        log("Bootstrapping...");
    </script>

    <!-- MODULE SCRIPT: Logic using Import Map -->
    <script type="module">
        import { DefaultRubyVM } from "@ruby/3.3-wasm-wasi";

        log("Module loaded successfully via Import Map.");
        updateProgress(10);

        const start = async () => {
            try {
                log("Initializing Terminal...");
                if (!window.Terminal) throw new Error("xterm.js not loaded");

                const term = new Terminal({
                    cursorBlink: true,
                    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                    fontSize: 18,
                    theme: { background: '#000000', foreground: '#f0f0f0' }
                });
                const fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);

                term.open(document.getElementById("terminal"));
                fitAddon.fit();
                window.addEventListener('resize', () => fitAddon.fit());
                updateProgress(30);

                log("Downloading Ruby WASM Kernel...");
                const response = await fetch(
                    "https://cdn.jsdelivr.net/npm/@ruby/3.3-wasm-wasi@2.6.0/dist/ruby+stdlib.wasm"
                );
                if (!response.ok) throw new Error(`Failed to fetch WASM: ${response.statusText}`);

                const buffer = await response.arrayBuffer();
                updateProgress(50);

                log("Compiling WebAssembly...");
                const module = await WebAssembly.compile(buffer);
                const { vm } = await DefaultRubyVM(module);
                updateProgress(70);

                log("Fetching Project Source Code...");
                // term.write("Fetching source files...\r\n");

                const files = [
                    "Source%20Code/TicTacToe/lib/main.rb",
                    "Source%20Code/TicTacToe/lib/game.rb",
                    "Source%20Code/TicTacToe/lib/board.rb",
                    "Source%20Code/TicTacToe/lib/player.rb",
                    "Source%20Code/TicTacToe/lib/display.rb"
                ];

                vm.eval(`require "fileutils"; FileUtils.mkdir_p("/src")`);

                let loadedCount = 0;
                for (const fileUrl of files) {
                    const fileName = decodeURIComponent(fileUrl).split('/').pop();
                    const res = await fetch(fileUrl);
                    if (!res.ok) {
                        throw new Error(`Failed to fetch ${fileUrl} (Status: ${res.status})`);
                    }
                    const content = await res.text();

                    // Safe injection
                    const safeContent = content.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$\{/g, '\\${').replace(/#\{/g, '\\#{');

                    vm.eval(`
                  File.write("/src/${fileName}", <<~'RUBY_EOF'
${safeContent}
RUBY_EOF
)
                `);
                    loadedCount++;
                    updateProgress(70 + (loadedCount / files.length * 20));
                }

                log("Booting Ruby VM...");
                updateProgress(100);

                setTimeout(() => {
                    document.getElementById("status").style.display = "none";
                    document.getElementById("terminal").style.display = "block";
                    fitAddon.fit();
                    term.focus();

                    term.clear();
                    term.write("\x1b[31;1mTic Tac Toe in Ruby\x1b[0m | Amey & Mega\r\n");
                    term.write("----------------------------------------------\r\n");

                    // I/O Override
                    vm.eval(`
                    require "js"
                    module Kernel
                        def gets
                            input = JS.global.call(:prompt, "Your Move (Input required):")
                            if input == JS::Null || input == nil
                                 # Exit gracefully on cancel
                                 return "exit\\n"
                            end
                            JS.global[:term].call(:write, input.to_s + "\\r\\n")
                            input.to_s + "\\n"
                        end
                    end
                    class JSStdout
                        def write(str)
                            clean = str.to_s.gsub("\\n", "\\r\\n")
                            JS.global[:term].call(:write, clean)
                        end
                    end
                    $stdout = JSStdout.new
                    $stderr = JSStdout.new
                `);

                    window.term = term;

                    vm.eval(`Dir.chdir("/src"); load "main.rb"`);
                }, 500);

            } catch (e) {
                log(e.message, true);
                // alert("Error: " + e.message); 
            }
        };

        start();
    </script>
</body>

</html>